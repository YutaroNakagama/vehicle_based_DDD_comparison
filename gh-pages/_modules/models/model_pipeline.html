

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>models.model_pipeline &mdash; Vehicle-based DDD Docs</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=837179f8"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Vehicle-based DDD Comparison
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">src</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html#bin">bin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../analysis.html">analysis package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../config.html">config module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../data_pipeline.html">data_pipeline package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../evaluation.html">evaluation package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../models.html">models package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../utils.html">utils package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Vehicle-based DDD Comparison</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">models.model_pipeline</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for models.model_pipeline</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Model Training Pipeline for Driver Drowsiness Detection.</span>

<span class="sd">This module orchestrates the entire model training workflow for the Driver Drowsiness Detection (DDD) system.</span>
<span class="sd">It provides the `train_pipeline` function, which serves as the central entry point for:</span>

<span class="sd">- Loading preprocessed data for the selected model type.</span>
<span class="sd">- Splitting data into training, validation, and test sets, with options for subject-wise splitting and k-fold cross-validation.</span>
<span class="sd">- Applying optional domain generalization techniques such as Domain Mixup, CORAL (Correlation Alignment), and VAE-based augmentation.</span>
<span class="sd">- Performing feature selection using various methods (e.g., Random Forest importance, Mutual Information, ANOVA F-test).</span>
<span class="sd">- Training model-specific architectures (e.g., LSTM, SVM, various tree-based classifiers) based on the configuration.</span>
<span class="sd">- Saving trained models and relevant artifacts.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">zscore</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span><span class="p">,</span> <span class="n">mean_squared_error</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">GroupKFold</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.feature_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">SelectKBest</span><span class="p">,</span> <span class="n">mutual_info_classif</span><span class="p">,</span> <span class="n">f_classif</span>  
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.ensemble</span><span class="w"> </span><span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.svm</span><span class="w"> </span><span class="kn">import</span> <span class="n">SVC</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyswarm</span><span class="w"> </span><span class="kn">import</span> <span class="n">pso</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">src.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">SUBJECT_LIST_PATH</span><span class="p">,</span> <span class="n">PROCESS_CSV_PATH</span><span class="p">,</span> <span class="n">MODEL_PKL_PATH</span><span class="p">,</span> <span class="n">TOP_K_FEATURES</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.utils.io.loaders</span><span class="w"> </span><span class="kn">import</span> <span class="n">read_subject_list</span><span class="p">,</span> <span class="n">read_train_subject_list_fold</span><span class="p">,</span> <span class="n">get_model_type</span><span class="p">,</span> <span class="n">load_subject_csvs</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.utils.io.split</span><span class="w"> </span><span class="kn">import</span> <span class="n">data_split</span><span class="p">,</span> <span class="n">data_split_by_subject</span><span class="p">,</span> <span class="n">data_time_split_by_subject</span><span class="p">,</span> <span class="n">time_stratified_three_way_split</span> 
<span class="kn">from</span><span class="w"> </span><span class="nn">src.utils.domain_generalization.domain_mixup</span><span class="w"> </span><span class="kn">import</span> <span class="n">generate_domain_labels</span><span class="p">,</span> <span class="n">domain_mixup</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.utils.domain_generalization.coral</span><span class="w"> </span><span class="kn">import</span> <span class="n">coral</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.utils.domain_generalization.vae_augment</span><span class="w"> </span><span class="kn">import</span> <span class="n">vae_augmentation</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.models.feature_selection.index</span><span class="w"> </span><span class="kn">import</span> <span class="n">calculate_feature_indices</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.models.feature_selection.anfis</span><span class="w"> </span><span class="kn">import</span> <span class="n">calculate_id</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.models.feature_selection.rf_importance</span><span class="w"> </span><span class="kn">import</span> <span class="n">select_top_features_by_importance</span> 
<span class="kn">from</span><span class="w"> </span><span class="nn">src.models.architectures.helpers</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_classifier</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.models.architectures.lstm</span><span class="w"> </span><span class="kn">import</span> <span class="n">lstm_train</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.models.architectures.SvmA</span><span class="w"> </span><span class="kn">import</span> <span class="n">SvmA_train</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.models.architectures.common</span><span class="w"> </span><span class="kn">import</span> <span class="n">common_train</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%(asctime)s</span><span class="s2"> - </span><span class="si">%(levelname)s</span><span class="s2"> - </span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="remove_outliers_zscore">
<a class="viewcode-back" href="../../models.html#models.model_pipeline.remove_outliers_zscore">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">remove_outliers_zscore</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Remove rows from a DataFrame where any specified column&#39;s Z-score exceeds the threshold.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        Input DataFrame.</span>
<span class="sd">    cols : list of str</span>
<span class="sd">        Column names to check for outliers.</span>
<span class="sd">    threshold : float, default=5.0</span>
<span class="sd">        Z-score threshold. Rows with Z-scores above this value are removed.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.DataFrame</span>
<span class="sd">        DataFrame with outlier rows removed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">zscore</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">cols</span><span class="p">],</span> <span class="n">nan_policy</span><span class="o">=</span><span class="s1">&#39;omit&#39;</span><span class="p">))</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">z</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span></div>


<div class="viewcode-block" id="save_feature_histograms">
<a class="viewcode-back" href="../../models.html#models.model_pipeline.save_feature_histograms">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">save_feature_histograms</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">feature_columns</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="s2">&quot;feature_hist_svg&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate and save histograms for the specified feature columns as SVG files.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        DataFrame containing feature data.</span>
<span class="sd">    feature_columns : list of str</span>
<span class="sd">        List of column names for which to generate histograms.</span>
<span class="sd">    outdir : str, default=&quot;feature_hist_svg&quot;</span>
<span class="sd">        Output directory to save the histogram SVG files.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">        SVG files are saved to the specified directory.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">feature_columns</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Count&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">.svg&quot;</span><span class="p">),</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;svg&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<span class="k">def</span><span class="w"> </span><span class="nf">_prepare_df_with_label_and_features</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Filter by KSS labels, add a binary ``label`` column, and return feature column names.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        Input DataFrame containing KSS labels and feature columns.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        A tuple containing:</span>

<span class="sd">        - ``df`` : pandas.DataFrame</span>
<span class="sd">            Filtered DataFrame with an added ``label`` column.</span>
<span class="sd">        - ``feature_columns`` : list of str</span>
<span class="sd">            List of feature column names including ``subject_id`` if present.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">src.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">KSS_BIN_LABELS</span><span class="p">,</span> <span class="n">KSS_LABEL_MAP</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;KSS_Theta_Alpha_Beta&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">KSS_BIN_LABELS</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;KSS_Theta_Alpha_Beta&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">KSS_LABEL_MAP</span><span class="p">)</span>
    <span class="n">start_col</span> <span class="o">=</span> <span class="s2">&quot;Steering_Range&quot;</span>
    <span class="n">end_col</span> <span class="o">=</span> <span class="s2">&quot;LaneOffset_AAA&quot;</span>
    <span class="n">feature_columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">start_col</span><span class="p">:</span><span class="n">end_col</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">if</span> <span class="s2">&quot;subject_id&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">feature_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;subject_id&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span><span class="p">,</span> <span class="n">feature_columns</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_log_split_ratios</span><span class="p">(</span><span class="n">y_tr</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">y_va</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">y_te</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">tag</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Log the sample counts, positive counts, and positive ratios for train, validation, and test splits.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    y_tr : pandas.Series</span>
<span class="sd">        Training labels.</span>
<span class="sd">    y_va : pandas.Series</span>
<span class="sd">        Validation labels.</span>
<span class="sd">    y_te : pandas.Series</span>
<span class="sd">        Test labels.</span>
<span class="sd">    tag : str, optional</span>
<span class="sd">        Optional tag to include in log messages.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">        Logs summary statistics for each split.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_r</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span> <span class="k">if</span> <span class="n">n</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">p</span> <span class="o">/</span> <span class="n">n</span> <span class="k">if</span> <span class="n">n</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">n</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">r</span>
    <span class="n">n_tr</span><span class="p">,</span> <span class="n">p_tr</span><span class="p">,</span> <span class="n">r_tr</span> <span class="o">=</span> <span class="n">_r</span><span class="p">(</span><span class="n">y_tr</span><span class="p">)</span>
    <span class="n">n_va</span><span class="p">,</span> <span class="n">p_va</span><span class="p">,</span> <span class="n">r_va</span> <span class="o">=</span> <span class="n">_r</span><span class="p">(</span><span class="n">y_va</span><span class="p">)</span>
    <span class="n">n_te</span><span class="p">,</span> <span class="n">p_te</span><span class="p">,</span> <span class="n">r_te</span> <span class="o">=</span> <span class="n">_r</span><span class="p">(</span><span class="n">y_te</span><span class="p">)</span>
    <span class="n">n_all</span> <span class="o">=</span> <span class="n">n_tr</span> <span class="o">+</span> <span class="n">n_va</span> <span class="o">+</span> <span class="n">n_te</span>
    <span class="n">p_all</span> <span class="o">=</span> <span class="n">p_tr</span> <span class="o">+</span> <span class="n">p_va</span> <span class="o">+</span> <span class="n">p_te</span>
    <span class="n">r_all</span> <span class="o">=</span> <span class="p">(</span><span class="n">p_all</span> <span class="o">/</span> <span class="n">n_all</span><span class="p">)</span> <span class="k">if</span> <span class="n">n_all</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[split</span><span class="si">%s</span><span class="s2">] global  : n=</span><span class="si">%d</span><span class="s2">, pos=</span><span class="si">%d</span><span class="s2">, pos_ratio=</span><span class="si">%.3f</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;:</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">tag</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">n_all</span><span class="p">,</span> <span class="n">p_all</span><span class="p">,</span> <span class="n">r_all</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[split</span><span class="si">%s</span><span class="s2">] train   : n=</span><span class="si">%d</span><span class="s2">, pos=</span><span class="si">%d</span><span class="s2">, pos_ratio=</span><span class="si">%.3f</span><span class="s2">, |Δ|=</span><span class="si">%.3f</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;:</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">tag</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">n_tr</span><span class="p">,</span> <span class="n">p_tr</span><span class="p">,</span> <span class="n">r_tr</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">r_tr</span> <span class="o">-</span> <span class="n">r_all</span><span class="p">)</span> <span class="k">if</span> <span class="n">n_tr</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">))</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[split</span><span class="si">%s</span><span class="s2">] val     : n=</span><span class="si">%d</span><span class="s2">, pos=</span><span class="si">%d</span><span class="s2">, pos_ratio=</span><span class="si">%.3f</span><span class="s2">, |Δ|=</span><span class="si">%.3f</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;:</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">tag</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">n_va</span><span class="p">,</span> <span class="n">p_va</span><span class="p">,</span> <span class="n">r_va</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">r_va</span> <span class="o">-</span> <span class="n">r_all</span><span class="p">)</span> <span class="k">if</span> <span class="n">n_va</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">))</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[split</span><span class="si">%s</span><span class="s2">] test    : n=</span><span class="si">%d</span><span class="s2">, pos=</span><span class="si">%d</span><span class="s2">, pos_ratio=</span><span class="si">%.3f</span><span class="s2">, |Δ|=</span><span class="si">%.3f</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;:</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">tag</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">n_te</span><span class="p">,</span> <span class="n">p_te</span><span class="p">,</span> <span class="n">r_te</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">r_te</span> <span class="o">-</span> <span class="n">r_all</span><span class="p">)</span> <span class="k">if</span> <span class="n">n_te</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">))</span>

<div class="viewcode-block" id="train_pipeline">
<a class="viewcode-back" href="../../models.html#models.model_pipeline.train_pipeline">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">train_pipeline</span><span class="p">(</span>
    <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">use_domain_mixup</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">use_coral</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">use_vae</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">sample_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">42</span><span class="p">,</span>
    <span class="n">fold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">n_folds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">tag</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
    <span class="n">subject_wise_split</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
    <span class="n">feature_selection_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;rf&quot;</span><span class="p">,</span> 
    <span class="n">data_leak</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">subject_split_strategy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;random&quot;</span><span class="p">,</span>
    <span class="n">target_subjects</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[],</span>
    <span class="n">train_subjects</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[],</span>
    <span class="n">val_subjects</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[],</span>
    <span class="n">test_subjects</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[],</span>
    <span class="n">general_subjects</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[],</span>
    <span class="n">finetune_setting</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>   
    <span class="n">save_pretrain</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>     
    <span class="n">eval_only_pretrained</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">balance_labels</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">balance_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;undersample&quot;</span><span class="p">,</span>
    <span class="n">time_stratify_labels</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">time_stratify_tolerance</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">,</span>
    <span class="n">time_stratify_window</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.10</span><span class="p">,</span>
    <span class="n">time_stratify_min_chunk</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Train a machine learning model for driver drowsiness detection.</span>

<span class="sd">    This function loads processed feature data, applies optional domain</span>
<span class="sd">    generalization techniques (Domain Mixup, CORAL, VAE), performs feature</span>
<span class="sd">    selection, and trains a model based on the specified configuration.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model_name : str</span>
<span class="sd">        The model to train (e.g., ``&#39;Lstm&#39;``, ``&#39;SvmA&#39;``, ``&#39;RF&#39;``).</span>
<span class="sd">    use_domain_mixup : bool, default=False</span>
<span class="sd">        Apply domain mixup augmentation.</span>
<span class="sd">    use_coral : bool, default=False</span>
<span class="sd">        Apply CORAL (Correlation Alignment) domain adaptation.</span>
<span class="sd">    use_vae : bool, default=False</span>
<span class="sd">        Apply VAE-based augmentation.</span>
<span class="sd">    sample_size : int, optional</span>
<span class="sd">        Number of subjects to subsample. If ``None``, use all subjects.</span>
<span class="sd">    seed : int, default=42</span>
<span class="sd">        Random seed for reproducibility.</span>
<span class="sd">    fold : int, optional</span>
<span class="sd">        Fold index for cross-validation.</span>
<span class="sd">    n_folds : int, optional</span>
<span class="sd">        Total number of folds for cross-validation.</span>
<span class="sd">    tag : str, optional</span>
<span class="sd">        Identifier appended to saved model artifacts.</span>
<span class="sd">    subject_wise_split : bool, default=False</span>
<span class="sd">        If True, ensures subjects are not mixed across splits.</span>
<span class="sd">    feature_selection_method : {&quot;rf&quot;, &quot;mi&quot;, &quot;anova&quot;}, default=&quot;rf&quot;</span>
<span class="sd">        Feature selection method:</span>
<span class="sd">        - ``&quot;rf&quot;`` : Random Forest importance</span>
<span class="sd">        - ``&quot;mi&quot;`` : Mutual Information</span>
<span class="sd">        - ``&quot;anova&quot;`` : ANOVA F-test</span>
<span class="sd">    data_leak : bool, default=False</span>
<span class="sd">        Allow intentional data leakage (for ablation studies).</span>
<span class="sd">    subject_split_strategy : str, default=&quot;random&quot;</span>
<span class="sd">        Strategy for subject splitting (e.g., ``&quot;random&quot;``, ``&quot;finetune_target_subjects&quot;``).</span>
<span class="sd">    target_subjects : list of str, optional</span>
<span class="sd">        List of subjects to treat as targets.</span>
<span class="sd">    train_subjects : list of str, optional</span>
<span class="sd">        Explicit subject list for training.</span>
<span class="sd">    val_subjects : list of str, optional</span>
<span class="sd">        Explicit subject list for validation.</span>
<span class="sd">    test_subjects : list of str, optional</span>
<span class="sd">        Explicit subject list for testing.</span>
<span class="sd">    general_subjects : list of str, optional</span>
<span class="sd">        List of general subjects for pretraining or domain generalization.</span>
<span class="sd">    finetune_setting : str, optional</span>
<span class="sd">        Path to pretrained feature/scaler configuration for fine-tuning.</span>
<span class="sd">    save_pretrain : str, optional</span>
<span class="sd">        Path to save pretraining artifacts (features/scaler).</span>
<span class="sd">    eval_only_pretrained : bool, default=False</span>
<span class="sd">        If True, skip fine-tuning and evaluate using pretrained model only.</span>
<span class="sd">    balance_labels : bool, default=False</span>
<span class="sd">        Whether to balance class distribution.</span>
<span class="sd">    balance_method : str, default=&quot;undersample&quot;</span>
<span class="sd">        Strategy for label balancing.</span>
<span class="sd">    time_stratify_labels : bool, default=False</span>
<span class="sd">        If True, apply time-stratified label splitting.</span>
<span class="sd">    time_stratify_tolerance : float, default=0.02</span>
<span class="sd">        Allowed tolerance for time-based stratification.</span>
<span class="sd">    time_stratify_window : float, default=0.10</span>
<span class="sd">        Window proportion for time-based stratification.</span>
<span class="sd">    time_stratify_min_chunk : int, default=100</span>
<span class="sd">        Minimum chunk size for time-based stratification.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">        Trained models and artifacts are saved to disk.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># 1. Load subject list</span>
    <span class="n">subject_list</span> <span class="o">=</span> <span class="n">read_subject_list</span><span class="p">()</span>

    <span class="c1"># 2. Subsample subjects if sample_size is specified</span>
    <span class="k">if</span> <span class="n">sample_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
        <span class="n">subject_list</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">subject_list</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">sample_size</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using </span><span class="si">{</span><span class="n">sample_size</span><span class="si">}</span><span class="s2"> subjects: </span><span class="si">{</span><span class="n">subject_list</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">model_type</span> <span class="o">=</span> <span class="n">get_model_type</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model type: </span><span class="si">{</span><span class="n">model_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># 3. Data Splitting based on strategy</span>
    <span class="k">if</span> <span class="n">subject_split_strategy</span> <span class="o">==</span> <span class="s2">&quot;single_subject_data_split&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">target_subjects</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_subjects</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;`single_subject_data_split` strategy requires exactly one subject in `--target_subjects`.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Performing single subject data split for: </span><span class="si">{</span><span class="n">target_subjects</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">load_subject_csvs</span><span class="p">(</span><span class="n">target_subjects</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">add_subject_id</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">X_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">data_split</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">train_ratio</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">val_ratio</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">test_ratio</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">subject_split_strategy</span> <span class="o">==</span> <span class="s2">&quot;isolate_target_subjects&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">target_subjects</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;`isolate_target_subjects` strategy requires `--target_subjects` to be set.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Isolating target subjects: </span><span class="si">{</span><span class="n">target_subjects</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Split target subjects: 80% train, 10% val, 10% test</span>
        <span class="n">train_subjects</span><span class="p">,</span> <span class="n">temp_subjects</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">target_subjects</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
        <span class="n">val_subjects</span><span class="p">,</span> <span class="n">test_subjects</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">temp_subjects</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
        
        <span class="n">use_subjects</span> <span class="o">=</span> <span class="n">target_subjects</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">load_subject_csvs</span><span class="p">(</span><span class="n">use_subjects</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">add_subject_id</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">X_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">data_split_by_subject</span><span class="p">(</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">train_subjects</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">val_subjects</span><span class="o">=</span><span class="n">val_subjects</span><span class="p">,</span> <span class="n">test_subjects</span><span class="o">=</span><span class="n">test_subjects</span>
        <span class="p">)</span>

    <span class="k">elif</span> <span class="n">subject_split_strategy</span> <span class="o">==</span> <span class="s2">&quot;finetune_target_subjects&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">target_subjects</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;`finetune_target_subjects` strategy requires `--target_subjects` to be set.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Finetuning with target subjects: </span><span class="si">{</span><span class="n">target_subjects</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Use all other subjects for the main training set</span>
        <span class="k">if</span> <span class="n">general_subjects</span><span class="p">:</span>
            <span class="n">general_subjects_list</span> <span class="o">=</span> <span class="n">general_subjects</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">general_subjects_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">subject_list</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">target_subjects</span><span class="p">]</span>

<span class="c1">#        # --- Step 1: Pretrain artifacts on general_subjects (features/scaler; and model when eval_only) ---</span>
        <span class="c1"># --- (helper) Build identical target splits for both FineTune and EvalOnly ---</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">_build_target_splits_df</span><span class="p">(</span><span class="n">dataframe</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Build consistent target splits for both fine-tuning and evaluation-only modes.</span>
<span class="sd">            </span>
<span class="sd">            Validation and test splits are created identically across modes to ensure</span>
<span class="sd">            fair comparison. In evaluation-only mode, the training split is ignored.</span>
<span class="sd">            </span>
<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            dataframe : pandas.DataFrame</span>
<span class="sd">                Input DataFrame containing subject, timestamp, and label columns.</span>
<span class="sd">            </span>
<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            tuple</span>
<span class="sd">                A tuple containing:</span>
<span class="sd">            </span>
<span class="sd">                - ``X_tr`` : pandas.DataFrame</span>
<span class="sd">                    Training feature matrix.</span>
<span class="sd">                - ``X_va`` : pandas.DataFrame</span>
<span class="sd">                    Validation feature matrix.</span>
<span class="sd">                - ``X_te`` : pandas.DataFrame</span>
<span class="sd">                    Test feature matrix.</span>
<span class="sd">                - ``y_tr`` : pandas.Series</span>
<span class="sd">                    Training labels.</span>
<span class="sd">                - ``y_va`` : pandas.Series</span>
<span class="sd">                    Validation labels.</span>
<span class="sd">                - ``y_te`` : pandas.Series</span>
<span class="sd">                    Test labels.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">time_stratify_labels</span><span class="p">:</span>
                <span class="n">df_lab</span><span class="p">,</span> <span class="n">feature_columns</span> <span class="o">=</span> <span class="n">_prepare_df_with_label_and_features</span><span class="p">(</span><span class="n">dataframe</span><span class="p">)</span>
                <span class="n">sort_keys</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;subject_id&quot;</span><span class="p">,</span> <span class="s2">&quot;Timestamp&quot;</span><span class="p">)</span>
                <span class="n">idx_tr</span><span class="p">,</span> <span class="n">idx_va</span><span class="p">,</span> <span class="n">idx_te</span> <span class="o">=</span> <span class="n">time_stratified_three_way_split</span><span class="p">(</span>
                    <span class="n">df_lab</span><span class="p">,</span> <span class="n">label_col</span><span class="o">=</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="n">sort_keys</span><span class="p">,</span>
                    <span class="n">train_ratio</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">val_ratio</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">test_ratio</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                    <span class="n">tolerance</span><span class="o">=</span><span class="n">time_stratify_tolerance</span><span class="p">,</span> <span class="n">window_prop</span><span class="o">=</span><span class="n">time_stratify_window</span><span class="p">,</span>
                    <span class="n">min_chunk</span><span class="o">=</span><span class="n">time_stratify_min_chunk</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">X_tr</span> <span class="o">=</span> <span class="n">df_lab</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx_tr</span><span class="p">,</span> <span class="n">feature_columns</span><span class="p">]</span>
                <span class="n">X_va</span> <span class="o">=</span> <span class="n">df_lab</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx_va</span><span class="p">,</span> <span class="n">feature_columns</span><span class="p">]</span>
                <span class="n">X_te</span> <span class="o">=</span> <span class="n">df_lab</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx_te</span><span class="p">,</span> <span class="n">feature_columns</span><span class="p">]</span>
                <span class="n">y_tr</span> <span class="o">=</span> <span class="n">df_lab</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx_tr</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">]</span>
                <span class="n">y_va</span> <span class="o">=</span> <span class="n">df_lab</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx_va</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">]</span>
                <span class="n">y_te</span> <span class="o">=</span> <span class="n">df_lab</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx_te</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">X_tr</span><span class="p">,</span> <span class="n">X_va</span><span class="p">,</span> <span class="n">X_te</span><span class="p">,</span> <span class="n">y_tr</span><span class="p">,</span> <span class="n">y_va</span><span class="p">,</span> <span class="n">y_te</span> <span class="o">=</span> <span class="n">data_time_split_by_subject</span><span class="p">(</span>
                    <span class="n">dataframe</span><span class="p">,</span> <span class="n">subject_col</span><span class="o">=</span><span class="s2">&quot;subject_id&quot;</span><span class="p">,</span> <span class="n">time_col</span><span class="o">=</span><span class="s2">&quot;Timestamp&quot;</span>
                <span class="p">)</span>
            <span class="c1"># Drop subject_id only at the very end so both paths are identical</span>
            <span class="n">X_tr</span> <span class="o">=</span> <span class="n">X_tr</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;subject_id&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
            <span class="n">X_va</span> <span class="o">=</span> <span class="n">X_va</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;subject_id&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
            <span class="n">X_te</span> <span class="o">=</span> <span class="n">X_te</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;subject_id&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">X_tr</span><span class="p">,</span> <span class="n">X_va</span><span class="p">,</span> <span class="n">X_te</span><span class="p">,</span> <span class="n">y_tr</span><span class="p">,</span> <span class="n">y_va</span><span class="p">,</span> <span class="n">y_te</span>

<span class="c1">#        # --- Step 1: Save pretrain artifacts (features/scaler) on general_subjects ---</span>
<span class="c1">#</span>
<span class="c1">#        if save_pretrain:</span>
<span class="c1">#        # Load general-subjects data once (used for pretrain artifacts and/or pretrain model)</span>
<span class="c1">#        general_data, _ = load_subject_csvs(general_subjects_list, model_type, add_subject_id=True)</span>
<span class="c1">#</span>
<span class="c1">#        # --- Step 1: Save pretrain artifacts (features/scaler) on general_subjects ---</span>
<span class="c1">#        if save_pretrain:</span>
        <span class="c1"># Load general-subjects data once (used for pretrain artifacts and/or pretrain model)</span>
        <span class="n">general_data</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">load_subject_csvs</span><span class="p">(</span><span class="n">general_subjects_list</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">add_subject_id</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># --- Step 1: Save pretrain artifacts (features/scaler) on general_subjects ---</span>
        <span class="k">if</span> <span class="n">save_pretrain</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">save_pretrain</span><span class="p">):</span>
                <span class="n">save_pretrain</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;model/common&quot;</span><span class="p">,</span> <span class="n">save_pretrain</span><span class="p">)</span>

<span class="c1">#            # 1. data load for only general_subjects</span>
<span class="c1">#            general_data, _ = load_subject_csvs(general_subjects_list, model_type, add_subject_id=True)</span>
            <span class="c1"># 2. random separation</span>
            <span class="n">X_gtrain</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">y_gtrain</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">data_split</span><span class="p">(</span><span class="n">general_data</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
            <span class="n">X_gtrain_for_fs</span> <span class="o">=</span> <span class="n">X_gtrain</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;subject_id&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
    
            <span class="c1"># 3. Feature Selection (e.g. RF importance)</span>
            <span class="n">selected_features</span> <span class="o">=</span> <span class="n">select_top_features_by_importance</span><span class="p">(</span><span class="n">X_gtrain_for_fs</span><span class="p">,</span> <span class="n">y_gtrain</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="n">TOP_K_FEATURES</span><span class="p">)</span>
    
            <span class="c1"># 4. Scaler</span>
            <span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
            <span class="n">scaler</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_gtrain_for_fs</span><span class="p">[</span><span class="n">selected_features</span><span class="p">])</span>
    
    
            <span class="c1"># 6. Save</span>
            <span class="n">pretrain_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;selected_features&quot;</span><span class="p">:</span> <span class="n">selected_features</span><span class="p">,</span>
                <span class="s2">&quot;scaler&quot;</span><span class="p">:</span> <span class="n">scaler</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">n_scale</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">scaler</span><span class="p">,</span> <span class="s2">&quot;n_features_in_&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">n_scale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">n_scale</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_features</span><span class="p">):</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;[EvalOnly] scaler.n_features_in_=</span><span class="si">%d</span><span class="s2"> != len(selected_features)=</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span>
                                    <span class="n">n_scale</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_features</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">save_pretrain</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">pretrain_dict</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved pretrain setting (features/scaler) to </span><span class="si">{</span><span class="n">save_pretrain</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1">#            # If we will do &quot;evaluate-only&quot; (no fine-tune), we also train and save a model on general_subjects here.</span>
<span class="c1">#            if eval_only_pretrained:</span>
<span class="c1">#                # Train a model using ONLY general_subjects, save as a distinct tag to avoid overwriting.</span>
<span class="c1">#                from src.models.architectures.common import common_train</span>
<span class="c1">#                clf = get_classifier(model_name)</span>
<span class="c1">#                pretrain_tag = &quot;_pretrain_general&quot;</span>
<span class="c1">#                logging.info(&quot;[EvalOnly] Training a model on general subjects only (no target data).&quot;)</span>
<span class="c1">#                # Use a standard random split for general_data to let common_train tune params.</span>
<span class="c1">#                X_gtr, X_gva, X_gte, y_gtr, y_gva, y_gte = data_split(general_data, random_state=seed)</span>
<span class="c1">#                # Drop subject_id from features for training</span>
<span class="c1">#                X_gtr_fs = X_gtr.drop(columns=[&quot;subject_id&quot;], errors=&quot;ignore&quot;)</span>
<span class="c1">#                X_gva_fs = X_gva.drop(columns=[&quot;subject_id&quot;], errors=&quot;ignore&quot;)</span>
<span class="c1">#                X_gte_fs = X_gte.drop(columns=[&quot;subject_id&quot;], errors=&quot;ignore&quot;)</span>
<span class="c1">#                # Fit scaler on general-train only for safety (already fit above; re-fit to keep isolation)</span>
<span class="c1">#                scaler_general = StandardScaler().fit(X_gtr_fs[selected_features])</span>
<span class="c1">#                common_train(</span>
<span class="c1">#                    X_gtr_fs, X_gva_fs, X_gte_fs,</span>
<span class="c1">#                    y_gtr, y_gva, y_gte,</span>
<span class="c1">#                    selected_features,</span>
<span class="c1">#                    model_name, model_type, clf,</span>
<span class="c1">#                    scaler=scaler_general,</span>
<span class="c1">#                    suffix=pretrain_tag,</span>
<span class="c1">#                    data_leak=data_leak,</span>
<span class="c1">#                )</span>
<span class="c1">#                # Persist the scaler we actually used to train the saved model</span>
<span class="c1">#                from src.config import MODEL_PKL_PATH</span>
<span class="c1">#                out_dir = f&quot;{MODEL_PKL_PATH}/{model_type}&quot;</span>
<span class="c1">#                with open(os.path.join(out_dir, f&quot;scaler_{model_name}{pretrain_tag}.pkl&quot;), &quot;wb&quot;) as f:</span>
<span class="c1">#                    pickle.dump(scaler_general, f)</span>
        <span class="c1"># If eval-only, ensure a pretrained model on general subjects exists; if not, train and save it.</span>
        <span class="k">if</span> <span class="n">eval_only_pretrained</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">src.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">MODEL_PKL_PATH</span>
            <span class="c1">#from src.models.architectures.common import common_train</span>
            <span class="n">clf</span> <span class="o">=</span> <span class="n">get_classifier</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span>
            <span class="n">pretrain_tag</span> <span class="o">=</span> <span class="s2">&quot;_pretrain_general&quot;</span>
            <span class="n">out_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">MODEL_PKL_PATH</span><span class="p">,</span> <span class="n">model_type</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">model_pkl</span>  <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}{</span><span class="n">pretrain_tag</span><span class="si">}</span><span class="s2">.pkl&quot;</span><span class="p">)</span>
            <span class="n">scaler_pkl</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;scaler_</span><span class="si">{</span><span class="n">model_name</span><span class="si">}{</span><span class="n">pretrain_tag</span><span class="si">}</span><span class="s2">.pkl&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">model_pkl</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">scaler_pkl</span><span class="p">)):</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[EvalOnly] Pretrained model/scaler not found; training on general subjects only.&quot;</span><span class="p">)</span>
                <span class="c1"># Prepare FS &amp; scaler if not already computed via save_pretrain</span>
                <span class="n">X_gtr</span><span class="p">,</span> <span class="n">X_gva</span><span class="p">,</span> <span class="n">X_gte</span><span class="p">,</span> <span class="n">y_gtr</span><span class="p">,</span> <span class="n">y_gva</span><span class="p">,</span> <span class="n">y_gte</span> <span class="o">=</span> <span class="n">data_split</span><span class="p">(</span><span class="n">general_data</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
                <span class="n">X_gtr_fs</span> <span class="o">=</span> <span class="n">X_gtr</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;subject_id&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
                <span class="n">X_gva_fs</span> <span class="o">=</span> <span class="n">X_gva</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;subject_id&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
                <span class="n">X_gte_fs</span> <span class="o">=</span> <span class="n">X_gte</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;subject_id&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
                <span class="n">selected_features_local</span> <span class="o">=</span> <span class="n">select_top_features_by_importance</span><span class="p">(</span><span class="n">X_gtr_fs</span><span class="p">,</span> <span class="n">y_gtr</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="n">TOP_K_FEATURES</span><span class="p">)</span>
                <span class="n">scaler_general</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_gtr_fs</span><span class="p">[</span><span class="n">selected_features_local</span><span class="p">])</span>
                <span class="n">common_train</span><span class="p">(</span>
                    <span class="n">X_gtr_fs</span><span class="p">,</span> <span class="n">X_gva_fs</span><span class="p">,</span> <span class="n">X_gte_fs</span><span class="p">,</span>
                    <span class="n">y_gtr</span><span class="p">,</span> <span class="n">y_gva</span><span class="p">,</span> <span class="n">y_gte</span><span class="p">,</span>
                    <span class="n">selected_features_local</span><span class="p">,</span>
                    <span class="n">model_name</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">clf</span><span class="p">,</span>
                    <span class="n">scaler</span><span class="o">=</span><span class="n">scaler_general</span><span class="p">,</span>
                    <span class="n">suffix</span><span class="o">=</span><span class="n">pretrain_tag</span><span class="p">,</span>
                    <span class="n">data_leak</span><span class="o">=</span><span class="n">data_leak</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">scaler_pkl</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">scaler_general</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[EvalOnly] Found existing pretrained model/scaler. Skipping retrain.&quot;</span><span class="p">)</span>

<span class="c1">#        # --- Step 2-A: Evaluate-Only mode (skip fine-tuning on targets, just evaluate) ---</span>
        <span class="c1"># --- Step 2-A: Evaluate-only mode (skip fine-tuning; just evaluate on targets) ---</span>
<span class="c1">#        if eval_only_pretrained:</span>
        <span class="k">if</span> <span class="n">eval_only_pretrained</span><span class="p">:</span>
            <span class="c1"># 2-A-1) Load pretrain artifacts</span>
<span class="c1">#            if not finetune_setting:</span>
<span class="c1">#                logging.error(&quot;`--eval_only_pretrained` requires `--finetune_setting` (features/scaler bundle).&quot;)</span>
<span class="c1">#                return</span>
<span class="c1">#            if not os.path.dirname(finetune_setting):</span>
<span class="c1">#                finetune_setting = os.path.join(&quot;model/common&quot;, finetune_setting)</span>
<span class="c1">#            with open(finetune_setting, &quot;rb&quot;) as f:</span>
<span class="c1">#                pretrain_dict = pickle.load(f)</span>
<span class="c1">#            selected_features = pretrain_dict[&quot;selected_features&quot;]</span>
            <span class="c1"># NOTE: eval-only では、実際に一般被験者で学習・保存された</span>
            <span class="c1"># selected_features_train_&lt;MODEL&gt;_pretrain_general.pkl を使う。</span>
            <span class="c1"># Load the model &amp; scaler trained on general subjects (saved with suffix &quot;_pretrain_general&quot;)</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">src.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">MODEL_PKL_PATH</span>
            <span class="n">pretrain_suffix</span> <span class="o">=</span> <span class="s2">&quot;_pretrain_general&quot;</span>
            <span class="n">model_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">MODEL_PKL_PATH</span><span class="p">,</span> <span class="n">model_type</span><span class="p">)</span>
            <span class="n">model_pkl</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}{</span><span class="n">pretrain_suffix</span><span class="si">}</span><span class="s2">.pkl&quot;</span><span class="p">)</span>
            <span class="n">scaler_pkl</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;scaler_</span><span class="si">{</span><span class="n">model_name</span><span class="si">}{</span><span class="n">pretrain_suffix</span><span class="si">}</span><span class="s2">.pkl&quot;</span><span class="p">)</span>
            <span class="n">feats_pkl</span>  <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;selected_features_train_</span><span class="si">{</span><span class="n">model_name</span><span class="si">}{</span><span class="n">pretrain_suffix</span><span class="si">}</span><span class="s2">.pkl&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">model_pkl</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">scaler_pkl</span><span class="p">)):</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[EvalOnly] Pretrained model or scaler not found: </span><span class="si">{</span><span class="n">model_pkl</span><span class="si">}</span><span class="s2"> / </span><span class="si">{</span><span class="n">scaler_pkl</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">model_pkl</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">best_clf</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">scaler_pkl</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">scaler</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">feats_pkl</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">feats_pkl</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">selected_features</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[EvalOnly] Loaded model features: </span><span class="si">{</span><span class="n">feats_pkl</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">selected_features</span><span class="p">)</span><span class="si">}</span><span class="s2"> cols)&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># 後方互換のため、見つからない場合は finetune_setting にフォールバック</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">finetune_setting</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;[EvalOnly] Neither model feature file nor finetune_setting is available.&quot;</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="n">path_fs</span> <span class="o">=</span> <span class="n">finetune_setting</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">finetune_setting</span><span class="p">)</span> <span class="k">else</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;model/common&quot;</span><span class="p">,</span> <span class="n">finetune_setting</span><span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_fs</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">pretrain_dict</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="n">selected_features</span> <span class="o">=</span> <span class="n">pretrain_dict</span><span class="p">[</span><span class="s2">&quot;selected_features&quot;</span><span class="p">]</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[EvalOnly] Feature file not found; fallback to finetune_setting features (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">selected_features</span><span class="p">)</span><span class="si">}</span><span class="s2"> cols).&quot;</span><span class="p">)</span>
 

<span class="c1">#            # 2-A-2) Build target splits (time-stratified or time-order split)</span>
<span class="c1">#            data, _ = load_subject_csvs(target_subjects, model_type, add_subject_id=True)</span>
<span class="c1">#            if time_stratify_labels:</span>
<span class="c1">#                df_lab, feature_columns = _prepare_df_with_label_and_features(data)</span>
<span class="c1">#                sort_keys = (&quot;subject_id&quot;, &quot;Timestamp&quot;)</span>
<span class="c1">#                idx_tr, idx_va, idx_te = time_stratified_three_way_split(</span>
<span class="c1">#                    df_lab, label_col=&quot;label&quot;, sort_keys=sort_keys,</span>
<span class="c1">#                    train_ratio=0.8, val_ratio=0.1, test_ratio=0.1,</span>
<span class="c1">#                    tolerance=time_stratify_tolerance, window_prop=time_stratify_window,</span>
<span class="c1">#                    min_chunk=time_stratify_min_chunk,</span>
<span class="c1">#                )</span>
<span class="c1">#                X_val = df_lab.loc[idx_va, feature_columns].drop(columns=[&quot;subject_id&quot;], errors=&quot;ignore&quot;)</span>
<span class="c1">#                X_test = df_lab.loc[idx_te, feature_columns].drop(columns=[&quot;subject_id&quot;], errors=&quot;ignore&quot;)</span>
<span class="c1">#                y_val = df_lab.loc[idx_va, &quot;label&quot;]</span>
<span class="c1">#                y_test = df_lab.loc[idx_te, &quot;label&quot;]</span>
<span class="c1">#            else:</span>
<span class="c1">#                # Use existing time-based split helper</span>
<span class="c1">#                X_tr, X_val, X_test, y_tr, y_val, y_test = data_time_split_by_subject(</span>
<span class="c1">#                    data, subject_col=&quot;subject_id&quot;, time_col=&quot;Timestamp&quot;</span>
<span class="c1">#                )</span>
<span class="c1">#                # Only use val/test for evaluation; train part is ignored in eval-only mode</span>
<span class="c1">#                X_val = X_val.drop(columns=[&quot;subject_id&quot;], errors=&quot;ignore&quot;)</span>
<span class="c1">#                X_test = X_test.drop(columns=[&quot;subject_id&quot;], errors=&quot;ignore&quot;)</span>
            <span class="c1"># Build target splits EXACTLY as in the fine-tune path; ignore train in eval-only</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">load_subject_csvs</span><span class="p">(</span><span class="n">target_subjects</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">add_subject_id</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">_X_train_tgt</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">_y_train_tgt</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">_build_target_splits_df</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

            <span class="c1"># 2-A-3) Transform and evaluate on target Val/Test</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
                <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span>
                <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">average_precision_score</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span><span class="p">,</span> <span class="n">precision_recall_curve</span>
            <span class="p">)</span>
            <span class="c1">#X_val_scaled  = scaler.transform(X_val[selected_features])</span>
            <span class="c1">#X_test_scaled = scaler.transform(X_test[selected_features])</span>

            <span class="n">missing</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">selected_features</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">X_val</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
            <span class="n">extra</span>   <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">X_val</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">selected_features</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">missing</span> <span class="ow">or</span> <span class="n">extra</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;[EvalOnly] feature mismatch before alignment: missing_in_val=</span><span class="si">%s</span><span class="s2"> extra_in_val=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                                <span class="n">missing</span><span class="p">[:</span><span class="mi">5</span><span class="p">],</span> <span class="n">extra</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span>

            <span class="n">missing_t</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">selected_features</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">X_test</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
            <span class="n">extra_t</span>   <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">X_test</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">selected_features</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">missing_t</span> <span class="ow">or</span> <span class="n">extra_t</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;[EvalOnly] feature mismatch (test) before alignment: missing_in_test=</span><span class="si">%s</span><span class="s2"> extra_in_test=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                                <span class="n">missing_t</span><span class="p">[:</span><span class="mi">5</span><span class="p">],</span> <span class="n">extra_t</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span>

            <span class="c1"># ---- align columns to training features (order + fill missing with scaler.mean_) ----</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">_align_features</span><span class="p">(</span><span class="n">X_df</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">,</span> <span class="n">scaler_obj</span><span class="p">):</span>
                <span class="c1"># 確実に DataFrame で受け取る</span>
                <span class="n">X_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_df</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="c1"># 足りない列 -&gt; scaler.mean_ で補完（標準化後 0 ）</span>
                <span class="n">filled</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">feature_names</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">X_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                        <span class="n">filled</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">X_df</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># 長さに合わせた定数 Series</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="n">scaler_obj</span><span class="o">.</span><span class="n">mean_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">scaler_obj</span><span class="p">,</span> <span class="s2">&quot;mean_&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">scaler_obj</span><span class="o">.</span><span class="n">mean_</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">feature_names</span><span class="p">)</span> <span class="k">else</span> <span class="mf">0.0</span>
                        <span class="n">filled</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">X_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
                <span class="n">X_out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">filled</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">feature_names</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">X_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                <span class="c1"># NaN は学習平均で埋める（安全策）</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">scaler_obj</span><span class="p">,</span> <span class="s2">&quot;mean_&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">scaler_obj</span><span class="o">.</span><span class="n">mean_</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">feature_names</span><span class="p">):</span>
                    <span class="n">means</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">scaler_obj</span><span class="o">.</span><span class="n">mean_</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">feature_names</span><span class="p">)</span>
                    <span class="n">X_out</span> <span class="o">=</span> <span class="n">X_out</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">means</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">X_out</span> <span class="o">=</span> <span class="n">X_out</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">X_out</span>

            <span class="n">X_val_aligned</span>  <span class="o">=</span> <span class="n">_align_features</span><span class="p">(</span><span class="n">X_val</span><span class="p">,</span>  <span class="n">selected_features</span><span class="p">,</span> <span class="n">scaler</span><span class="p">)</span>
            <span class="n">X_test_aligned</span> <span class="o">=</span> <span class="n">_align_features</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">selected_features</span><span class="p">,</span> <span class="n">scaler</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">n_scale</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">scaler</span><span class="p">,</span> <span class="s2">&quot;n_features_in_&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[EvalOnly] scaler expects n_features=</span><span class="si">%s</span><span class="s2">, aligned_features=</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span>
                             <span class="nb">str</span><span class="p">(</span><span class="n">n_scale</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_features</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">X_val_scaled</span>   <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_val_aligned</span><span class="p">)</span>
            <span class="n">X_test_scaled</span>  <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test_aligned</span><span class="p">)</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">_eval_block</span><span class="p">(</span><span class="n">Xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">):</span>
                <span class="n">out</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;accuracy&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">accuracy_score</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">best_clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">Xs</span><span class="p">))),</span>
                    <span class="s2">&quot;precision&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">precision_score</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">best_clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">Xs</span><span class="p">),</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)),</span>
                    <span class="s2">&quot;recall&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">recall_score</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">best_clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">Xs</span><span class="p">),</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)),</span>
                    <span class="s2">&quot;f1&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">f1_score</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">best_clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">Xs</span><span class="p">),</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)),</span>
                    <span class="s2">&quot;auc&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;ap&quot;</span><span class="p">:</span>  <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">),</span>
                <span class="p">}</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">proba</span> <span class="o">=</span> <span class="n">best_clf</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">Xs</span><span class="p">)[:,</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">out</span><span class="p">[</span><span class="s2">&quot;auc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">roc_auc_score</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">proba</span><span class="p">))</span>
                    <span class="n">out</span><span class="p">[</span><span class="s2">&quot;ap&quot;</span><span class="p">]</span>  <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">average_precision_score</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">proba</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">return</span> <span class="n">out</span>

            <span class="n">m_val</span>  <span class="o">=</span> <span class="n">_eval_block</span><span class="p">(</span><span class="n">X_val_scaled</span><span class="p">,</span>  <span class="n">y_val</span><span class="p">)</span>
            <span class="n">m_test</span> <span class="o">=</span> <span class="n">_eval_block</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">confusion_matrix</span>
                <span class="n">y_val_pred</span>  <span class="o">=</span> <span class="n">best_clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_val_scaled</span><span class="p">)</span>
                <span class="n">y_test_pred</span> <span class="o">=</span> <span class="n">best_clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[EvalOnly] val pos_ratio=</span><span class="si">%.3f</span><span class="s2">, pred_pos_ratio=</span><span class="si">%.3f</span><span class="s2">&quot;</span><span class="p">,</span>
                             <span class="nb">float</span><span class="p">(</span><span class="n">y_val</span><span class="o">.</span><span class="n">mean</span><span class="p">()),</span> <span class="nb">float</span><span class="p">(</span><span class="n">y_val_pred</span><span class="o">.</span><span class="n">mean</span><span class="p">()))</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[EvalOnly] test pos_ratio=</span><span class="si">%.3f</span><span class="s2">, pred_pos_ratio=</span><span class="si">%.3f</span><span class="s2">&quot;</span><span class="p">,</span>
                             <span class="nb">float</span><span class="p">(</span><span class="n">y_test</span><span class="o">.</span><span class="n">mean</span><span class="p">()),</span> <span class="nb">float</span><span class="p">(</span><span class="n">y_test_pred</span><span class="o">.</span><span class="n">mean</span><span class="p">()))</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[EvalOnly] val CM=</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_val</span><span class="p">,</span>  <span class="n">y_val_pred</span><span class="p">))</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[EvalOnly] test CM=</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_test_pred</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;[EvalOnly] could not print confusion matrices: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
<span class="c1">#            logging.info(f&quot;[EvalOnly] {model_name} on targets (no fine-tune): &quot;</span>
<span class="c1">#                         f&quot;val acc={m_val[&#39;accuracy&#39;]:.3f}, test acc={m_test[&#39;accuracy&#39;]:.3f}&quot;)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;[EvalOnly] </span><span class="si">%s</span><span class="s2"> on targets: &quot;</span>
                <span class="s2">&quot;val acc=</span><span class="si">%.3f</span><span class="s2"> auc=</span><span class="si">%.3f</span><span class="s2"> ap=</span><span class="si">%.3f</span><span class="s2"> | &quot;</span>
                <span class="s2">&quot;test acc=</span><span class="si">%.3f</span><span class="s2"> auc=</span><span class="si">%.3f</span><span class="s2"> ap=</span><span class="si">%.3f</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">model_name</span><span class="p">,</span>
                <span class="n">m_val</span><span class="p">[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">],</span> <span class="n">m_val</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;auc&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)),</span> <span class="n">m_val</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ap&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)),</span>
                <span class="n">m_test</span><span class="p">[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">],</span> <span class="n">m_test</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;auc&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)),</span> <span class="n">m_test</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ap&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)),</span>
            <span class="p">)</span>

            <span class="c1"># Save CSV (so it aligns with your usual artifacts)</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">src.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">MODEL_PKL_PATH</span>
            <span class="n">out_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">MODEL_PKL_PATH</span><span class="p">,</span> <span class="n">model_type</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1">#import pandas as pd, json</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="c1">#            pd.DataFrame([</span>
<span class="c1">#                {&quot;split&quot;:&quot;val&quot;, **m_val},</span>
<span class="c1">#                {&quot;split&quot;:&quot;test&quot;, **m_test},</span>
<span class="c1">#            ]).to_csv(os.path.join(out_dir, f&quot;metrics_{model_name}_evalonly_on_targets.csv&quot;), index=False)</span>
<span class="c1">#            logging.info(f&quot;[EvalOnly] Saved -&gt; {out_dir}/metrics_{model_name}_evalonly_on_targets.csv&quot;)</span>
            <span class="c1"># build suffix to avoid overwriting across groups</span>
            <span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="n">tag</span><span class="p">:</span>
                <span class="n">suffix</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">elif</span> <span class="n">target_subjects</span><span class="p">:</span>
                <span class="n">safe_targets</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">target_subjects</span><span class="p">))[:</span><span class="mi">40</span><span class="p">]</span>
                <span class="n">suffix</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;_targets-</span><span class="si">{</span><span class="n">safe_targets</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;PBS_ARRAY_INDEX&quot;</span><span class="p">):</span>
                <span class="n">suffix</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;_group</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;PBS_ARRAY_INDEX&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="p">[{</span><span class="s2">&quot;split&quot;</span><span class="p">:</span><span class="s2">&quot;val&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">m_val</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;split&quot;</span><span class="p">:</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">m_test</span><span class="p">}]</span>
            <span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;metrics_</span><span class="si">{</span><span class="n">model_name</span><span class="si">}{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">_evalonly_on_targets.csv&quot;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[EvalOnly] Saved -&gt; </span><span class="si">{</span><span class="n">out_dir</span><span class="si">}</span><span class="s2">/metrics_</span><span class="si">{</span><span class="n">model_name</span><span class="si">}{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">_evalonly_on_targets.csv&quot;</span><span class="p">)</span>

            <span class="k">return</span>

<span class="c1">#        # --- Step 2-B: (Default) Fine-tuning path using finetune_setting ---</span>
        <span class="c1"># --- Step 2-B: (Default) Fine-tuning path using finetune_setting ---</span>
        <span class="k">if</span> <span class="n">finetune_setting</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">finetune_setting</span><span class="p">):</span>
                <span class="n">finetune_setting</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;model/common&quot;</span><span class="p">,</span> <span class="n">finetune_setting</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">finetune_setting</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">pretrain_dict</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="n">selected_features</span> <span class="o">=</span> <span class="n">pretrain_dict</span><span class="p">[</span><span class="s2">&quot;selected_features&quot;</span><span class="p">]</span>
            <span class="n">scaler</span> <span class="o">=</span> <span class="n">pretrain_dict</span><span class="p">[</span><span class="s2">&quot;scaler&quot;</span><span class="p">]</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded pretrain setting from </span><span class="si">{</span><span class="n">finetune_setting</span><span class="si">}</span><span class="s2">: features=</span><span class="si">{</span><span class="n">selected_features</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Use the SAME split builder so eval-only and fine-tune share val/test</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">load_subject_csvs</span><span class="p">(</span><span class="n">target_subjects</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">add_subject_id</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">X_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">_build_target_splits_df</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

            <span class="n">_log_split_ratios</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;finetune_setting&quot;</span><span class="p">)</span>

            <span class="c1"># --- Feature selection and scaling ---</span>
<span class="c1">#            clf = get_classifier(model_name)</span>
<span class="c1">#            suffix = &quot;&quot;</span>
<span class="c1">#            if tag:</span>
<span class="c1">#                suffix += f&quot;_{tag}&quot;</span>
<span class="c1">##                # if finetune, add _finetune</span>
<span class="c1">##                if &quot;finetune&quot; in tag:</span>
<span class="c1">##                    suffix += &quot;_finetune&quot;</span>
<span class="c1">#            elif target_subjects:</span>
<span class="c1">#                # if there is no tag, add group number</span>
<span class="c1">#                safe_targets = &quot;-&quot;.join(map(str, target_subjects))[:40]  </span>
<span class="c1">#                suffix += f&quot;_targets-{safe_targets}&quot;</span>

            <span class="n">clf</span> <span class="o">=</span> <span class="n">get_classifier</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span>
            <span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="n">tag</span><span class="p">:</span>
                <span class="n">suffix</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">_finetune&quot;</span>
            <span class="k">elif</span> <span class="n">target_subjects</span><span class="p">:</span>
                <span class="n">safe_targets</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">target_subjects</span><span class="p">))[:</span><span class="mi">40</span><span class="p">]</span>
                <span class="n">suffix</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;_targets-</span><span class="si">{</span><span class="n">safe_targets</span><span class="si">}</span><span class="s2">_finetune&quot;</span>

            <span class="n">common_train</span><span class="p">(</span>
                <span class="n">X_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span>
                <span class="n">selected_features</span><span class="p">,</span>
                <span class="n">model_name</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">clf</span><span class="p">,</span>
                <span class="n">scaler</span><span class="o">=</span><span class="n">scaler</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="n">suffix</span><span class="p">,</span> <span class="n">data_leak</span><span class="o">=</span><span class="n">data_leak</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span>  
        
        <span class="c1"># Split target subjects for validation and testing (if more than one target subject)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_subjects</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">target_train_subjects</span><span class="p">,</span> <span class="n">temp_subjects</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">target_subjects</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
            <span class="n">val_subjects</span><span class="p">,</span> <span class="n">test_subjects</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">temp_subjects</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># Only one target subject, use data_split for within-subject split</span>
            <span class="n">target_train_subjects</span> <span class="o">=</span> <span class="n">target_subjects</span> <span class="c1"># The single subject is the &#39;target_train_subject&#39;</span>
            <span class="c1"># Load data for the single target subject to split it</span>
            <span class="n">single_subject_data</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">load_subject_csvs</span><span class="p">(</span><span class="n">target_subjects</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">add_subject_id</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">X_single_train</span><span class="p">,</span> <span class="n">X_single_val</span><span class="p">,</span> <span class="n">X_single_test</span><span class="p">,</span> <span class="n">y_single_train</span><span class="p">,</span> <span class="n">y_single_val</span><span class="p">,</span> <span class="n">y_single_test</span> <span class="o">=</span> <span class="n">data_split</span><span class="p">(</span><span class="n">single_subject_data</span><span class="p">,</span> <span class="n">train_ratio</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">val_ratio</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">test_ratio</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
            <span class="c1"># These will be used later to construct the final X_val, y_val, X_test, y_test</span>

            <span class="n">val_subjects</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># No separate validation subject list</span>
            <span class="n">test_subjects</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># No separate test subject list</span>

        
        <span class="c1"># Load all data (general subjects + target subjects)</span>
        <span class="n">use_subjects</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">general_subjects_list</span> <span class="o">+</span> <span class="n">target_subjects</span><span class="p">))</span> <span class="c1"># Ensure unique subjects</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">load_subject_csvs</span><span class="p">(</span><span class="n">use_subjects</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">add_subject_id</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_subjects</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">train_subjects</span> <span class="o">=</span> <span class="n">general_subjects_list</span> <span class="o">+</span> <span class="n">target_train_subjects</span>
            <span class="n">X_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">data_split_by_subject</span><span class="p">(</span>
                <span class="n">data</span><span class="p">,</span> <span class="n">train_subjects</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">val_subjects</span><span class="o">=</span><span class="n">val_subjects</span><span class="p">,</span> <span class="n">test_subjects</span><span class="o">=</span><span class="n">test_subjects</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># Single target subject case</span>
            <span class="c1"># Combine general subjects data with the single target subject&#39;s training data</span>
            <span class="n">X_general_train</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">y_general_train</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">data_split_by_subject</span><span class="p">(</span>
                <span class="n">data</span><span class="p">,</span> <span class="n">general_subjects_list</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">val_subjects</span><span class="o">=</span><span class="p">[],</span> <span class="n">test_subjects</span><span class="o">=</span><span class="p">[]</span>
            <span class="p">)</span>
            <span class="n">X_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">X_general_train</span><span class="p">,</span> <span class="n">X_single_train</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">y_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">y_general_train</span><span class="p">,</span> <span class="n">y_single_train</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">X_val</span> <span class="o">=</span> <span class="n">X_single_val</span>
            <span class="n">y_val</span> <span class="o">=</span> <span class="n">y_single_val</span>
            <span class="n">X_test</span> <span class="o">=</span> <span class="n">X_single_test</span>
            <span class="n">y_test</span> <span class="o">=</span> <span class="n">y_single_test</span>

            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;X_train shape after finetune_target_subjects (single subject): </span><span class="si">{</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;X_val   shape after finetune_target_subjects (single subject): </span><span class="si">{</span><span class="n">X_val</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;X_test  shape after finetune_target_subjects (single subject): </span><span class="si">{</span><span class="n">X_test</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">subject_split_strategy</span> <span class="o">==</span> <span class="s2">&quot;subject_time_split&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">target_subjects</span><span class="p">:</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">load_subject_csvs</span><span class="p">(</span><span class="n">target_subjects</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">add_subject_id</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">load_subject_csvs</span><span class="p">(</span><span class="n">subject_list</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">add_subject_id</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1">##        X_train, X_val, X_test, y_train, y_val, y_test = data_time_split_by_subject(</span>
<span class="c1">##            data, subject_col=&quot;subject_id&quot;, time_col=&quot;Timestamp&quot;</span>
<span class="c1">##        )</span>
<span class="c1">#</span>
<span class="c1">#        # ... after data is loaded as `data` and includes label column `label`</span>
<span class="c1">#        if subject_split_strategy in (&quot;subject_time_split&quot;, &quot;single_subject_data_split&quot;) and time_stratify_labels:</span>
<span class="c1">#            # build sort keys to keep per-subject chronology</span>
<span class="c1">#            sort_keys = (&quot;subject_id&quot;, &quot;Timestamp&quot;)</span>
<span class="c1">#            idx_tr, idx_va, idx_te = time_stratified_three_way_split(</span>
<span class="c1">#                data,</span>
<span class="c1">#                label_col=&quot;label&quot;,                 # &lt;-- adjust to your actual binary label col</span>
<span class="c1">#                sort_keys=sort_keys,</span>
<span class="c1">#                train_ratio=0.8, val_ratio=0.1, test_ratio=0.1,</span>
<span class="c1">#                tolerance=time_stratify_tolerance,</span>
<span class="c1">#                window_prop=time_stratify_window,</span>
<span class="c1">#                min_chunk=time_stratify_min_chunk,</span>
<span class="c1">#            )</span>
<span class="c1">#            # slice X/y (drop label/subject_id from X later in the pipeline as you already do)</span>
<span class="c1">#            X_train, y_train = data.loc[idx_tr].drop(columns=[]), data.loc[idx_tr, &quot;label&quot;]</span>
<span class="c1">#            X_val,   y_val   = data.loc[idx_va].drop(columns=[]), data.loc[idx_va, &quot;label&quot;]</span>
<span class="c1">#            X_test,  y_test  = data.loc[idx_te].drop(columns=[]), data.loc[idx_te, &quot;label&quot;]</span>
<span class="c1">#        else:</span>
<span class="c1">#            # fall back to your existing splitting path</span>
<span class="c1">#            X_train, X_val, X_test, y_train, y_val, y_test = data_time_split_by_subject(</span>
<span class="c1">#                data, subject_col=&quot;subject_id&quot;, time_col=&quot;Timestamp&quot;</span>
<span class="c1">#            )</span>

        <span class="k">if</span> <span class="n">time_stratify_labels</span><span class="p">:</span>
            <span class="n">df_lab</span><span class="p">,</span> <span class="n">feature_columns</span> <span class="o">=</span> <span class="n">_prepare_df_with_label_and_features</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">sort_keys</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;subject_id&quot;</span><span class="p">,</span> <span class="s2">&quot;Timestamp&quot;</span><span class="p">)</span>  <span class="c1"># ここは実データ列名に合わせる</span>
            <span class="n">idx_tr</span><span class="p">,</span> <span class="n">idx_va</span><span class="p">,</span> <span class="n">idx_te</span> <span class="o">=</span> <span class="n">time_stratified_three_way_split</span><span class="p">(</span>
                <span class="n">df_lab</span><span class="p">,</span>
                <span class="n">label_col</span><span class="o">=</span><span class="s2">&quot;label&quot;</span><span class="p">,</span>
                <span class="n">sort_keys</span><span class="o">=</span><span class="n">sort_keys</span><span class="p">,</span>
                <span class="n">train_ratio</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">val_ratio</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">test_ratio</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                <span class="n">tolerance</span><span class="o">=</span><span class="n">time_stratify_tolerance</span><span class="p">,</span>
                <span class="n">window_prop</span><span class="o">=</span><span class="n">time_stratify_window</span><span class="p">,</span>
                <span class="n">min_chunk</span><span class="o">=</span><span class="n">time_stratify_min_chunk</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># 特徴から label を除外</span>
            <span class="n">X_train</span> <span class="o">=</span> <span class="n">df_lab</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx_tr</span><span class="p">,</span> <span class="n">feature_columns</span><span class="p">]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;subject_id&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
            <span class="n">X_val</span>   <span class="o">=</span> <span class="n">df_lab</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx_va</span><span class="p">,</span> <span class="n">feature_columns</span><span class="p">]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;subject_id&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
            <span class="n">X_test</span>  <span class="o">=</span> <span class="n">df_lab</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx_te</span><span class="p">,</span> <span class="n">feature_columns</span><span class="p">]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;subject_id&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
            <span class="n">y_train</span> <span class="o">=</span> <span class="n">df_lab</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx_tr</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">]</span>
            <span class="n">y_val</span>   <span class="o">=</span> <span class="n">df_lab</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx_va</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">]</span>
            <span class="n">y_test</span>  <span class="o">=</span> <span class="n">df_lab</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx_te</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">X_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">data_time_split_by_subject</span><span class="p">(</span>
                <span class="n">data</span><span class="p">,</span> <span class="n">subject_col</span><span class="o">=</span><span class="s2">&quot;subject_id&quot;</span><span class="p">,</span> <span class="n">time_col</span><span class="o">=</span><span class="s2">&quot;Timestamp&quot;</span>
            <span class="p">)</span>

    <span class="k">elif</span> <span class="n">subject_wise_split</span> <span class="ow">and</span> <span class="n">fold</span> <span class="ow">and</span> <span class="n">fold</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Existing logic for cross-validation</span>
        <span class="n">n_splits</span> <span class="o">=</span> <span class="n">n_folds</span>
        <span class="n">subject_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">subject_list</span><span class="p">)</span>
        <span class="n">gkf</span> <span class="o">=</span> <span class="n">GroupKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="n">n_splits</span><span class="p">)</span>

        <span class="n">splits</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">gkf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">subject_array</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="n">subject_array</span><span class="p">))</span>
        <span class="n">train_idx</span><span class="p">,</span> <span class="n">test_idx</span> <span class="o">=</span> <span class="n">splits</span><span class="p">[</span><span class="n">fold</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">train_subjects</span> <span class="o">=</span> <span class="n">subject_array</span><span class="p">[</span><span class="n">train_idx</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">test_subjects</span> <span class="o">=</span> <span class="n">subject_array</span><span class="p">[</span><span class="n">test_idx</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
        <span class="n">n_train</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train_subjects</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.9</span><span class="p">)</span>
        <span class="n">shuffled</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">train_subjects</span><span class="p">)</span>
        <span class="n">actual_train_subjects</span> <span class="o">=</span> <span class="n">shuffled</span><span class="p">[:</span><span class="n">n_train</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">val_subjects</span> <span class="o">=</span> <span class="n">shuffled</span><span class="p">[</span><span class="n">n_train</span><span class="p">:]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="n">use_subjects</span> <span class="o">=</span> <span class="n">actual_train_subjects</span> <span class="o">+</span> <span class="n">val_subjects</span> <span class="o">+</span> <span class="n">test_subjects</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">load_subject_csvs</span><span class="p">(</span><span class="n">use_subjects</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">add_subject_id</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">X_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">data_split_by_subject</span><span class="p">(</span>
            <span class="n">data</span><span class="p">,</span>
            <span class="n">actual_train_subjects</span><span class="p">,</span>
            <span class="n">seed</span><span class="p">,</span>
            <span class="n">val_subjects</span><span class="o">=</span><span class="n">val_subjects</span><span class="p">,</span>
            <span class="n">test_subjects</span><span class="o">=</span><span class="n">test_subjects</span>
        <span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;X_train shape after subject-wise data split: </span><span class="si">{</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;X_val   shape after subject-wise data split: </span><span class="si">{</span><span class="n">X_val</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;X_test  shape after subject-wise data split: </span><span class="si">{</span><span class="n">X_test</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Default random split</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">feature_columns</span> <span class="o">=</span> <span class="n">load_subject_csvs</span><span class="p">(</span><span class="n">subject_list</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">add_subject_id</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">X_train</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">data_split</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;X_train shape after random data split: </span><span class="si">{</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;X_val   shape after random data split: </span><span class="si">{</span><span class="n">X_val</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;X_test  shape after random data split: </span><span class="si">{</span><span class="n">X_test</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">_log_split_ratios</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subject_split_strategy</span><span class="si">}</span><span class="s2">|time_stratify=</span><span class="si">{</span><span class="n">time_stratify_labels</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># 4. Data Validation: Check for empty splits or non-binary labels</span>
    <span class="k">if</span> <span class="n">y_train</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Training labels are not binary. Found: </span><span class="si">{</span><span class="n">y_train</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    
    <span class="c1"># Check for empty splits</span>
    <span class="k">if</span> <span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">X_val</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">X_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Train/val/test split has empty set. Try increasing sample_size or reviewing KSS filtering.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># 5. Domain Generalization Techniques</span>
    <span class="k">if</span> <span class="n">use_domain_mixup</span><span class="p">:</span>
        <span class="n">domain_labels_train</span> <span class="o">=</span> <span class="n">generate_domain_labels</span><span class="p">(</span><span class="n">subject_list</span><span class="p">,</span> <span class="n">X_train</span><span class="p">)</span>
        <span class="n">X_train_aug</span><span class="p">,</span> <span class="n">y_train_aug</span> <span class="o">=</span> <span class="n">domain_mixup</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">domain_labels_train</span><span class="p">)</span>
        <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">X_train_aug</span><span class="p">,</span> <span class="n">y_train_aug</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Applied Domain Mixup. New X_train shape: </span><span class="si">{</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Model-specific training dispatch</span>
    <span class="k">if</span> <span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;Lstm&#39;</span><span class="p">:</span>
        <span class="n">lstm_train</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">model_name</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;LSTM model training initiated.&quot;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;SvmA&#39;</span><span class="p">:</span>
        <span class="n">X_train_for_fs</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;subject_id&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
        <span class="n">X_val_for_fs</span> <span class="o">=</span> <span class="n">X_val</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;subject_id&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
        <span class="n">X_train_for_fs</span> <span class="o">=</span> <span class="n">X_train_for_fs</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">])</span>
        <span class="n">X_val_for_fs</span> <span class="o">=</span> <span class="n">X_val_for_fs</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">])</span>
    
        <span class="n">y_train</span> <span class="o">=</span> <span class="n">y_train</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">y_val</span> <span class="o">=</span> <span class="n">y_val</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">feature_indices</span> <span class="o">=</span> <span class="n">calculate_feature_indices</span><span class="p">(</span><span class="n">X_train_for_fs</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
        <span class="n">SvmA_train</span><span class="p">(</span><span class="n">X_train_for_fs</span><span class="p">,</span> <span class="n">X_val_for_fs</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span> <span class="n">feature_indices</span><span class="p">,</span> <span class="n">model_name</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;SvmA model training initiated with internal feature selection.&quot;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">X_train_for_fs</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;subject_id&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
        <span class="n">X_val_for_fs</span> <span class="o">=</span> <span class="n">X_val</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;subject_id&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

        <span class="n">X_train_for_fs</span> <span class="o">=</span> <span class="n">X_train_for_fs</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">X_val_for_fs</span> <span class="o">=</span> <span class="n">X_val_for_fs</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">y_train</span> <span class="o">=</span> <span class="n">y_train</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">y_val</span> <span class="o">=</span> <span class="n">y_val</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;y_train unique: </span><span class="si">{</span><span class="n">y_train</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="si">}</span><span class="s2">, counts: </span><span class="si">{</span><span class="n">y_train</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># 7. Feature Selection</span>
        <span class="n">selected_features</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">feature_selection_method</span> <span class="o">==</span> <span class="s2">&quot;mi&quot;</span><span class="p">:</span>
            <span class="c1"># Mutual Information based feature selection</span>
            <span class="n">selector</span> <span class="o">=</span> <span class="n">SelectKBest</span><span class="p">(</span><span class="n">score_func</span><span class="o">=</span><span class="n">mutual_info_classif</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">TOP_K_FEATURES</span><span class="p">)</span>
            <span class="n">selector</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_for_fs</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
            <span class="n">selected_mask</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="n">get_support</span><span class="p">()</span>
            <span class="n">selected_features</span> <span class="o">=</span> <span class="n">X_train_for_fs</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">selected_mask</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Selected features (mutual_info): </span><span class="si">{</span><span class="n">selected_features</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">feature_selection_method</span> <span class="o">==</span> <span class="s2">&quot;anova&quot;</span><span class="p">:</span>  
            <span class="c1"># ANOVA F-test based feature selection</span>
            <span class="n">selector</span> <span class="o">=</span> <span class="n">SelectKBest</span><span class="p">(</span><span class="n">score_func</span><span class="o">=</span><span class="n">f_classif</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">TOP_K_FEATURES</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">data_leak</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="c1"># Fit selector on combined train and validation data if data_leak is True</span>
                <span class="n">selector</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">X_train_for_fs</span><span class="p">,</span> <span class="n">X_val_for_fs</span><span class="p">]),</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_val</span><span class="p">]))</span>  
                <span class="n">selected_mask</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="n">get_support</span><span class="p">()</span>
                <span class="n">selected_features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">X_train_for_fs</span><span class="p">,</span> <span class="n">X_val_for_fs</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">selected_mask</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Fit selector only on training data</span>
                <span class="n">selector</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_for_fs</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
                <span class="n">selected_mask</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="n">get_support</span><span class="p">()</span>
                <span class="n">selected_features</span> <span class="o">=</span> <span class="n">X_train_for_fs</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">selected_mask</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Selected features (ANOVA F-test): </span><span class="si">{</span><span class="n">selected_features</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="c1">#            data_clean = remove_outliers_zscore(data, selected_features, threshold=5.0)</span>
<span class="c1">#            save_feature_histograms(data, selected_features, outdir=&quot;./data/log/&quot;)</span>
        
        <span class="k">elif</span> <span class="n">feature_selection_method</span> <span class="o">==</span> <span class="s2">&quot;rf&quot;</span><span class="p">:</span>
            <span class="c1"># Random Forest importance based feature selection</span>
            <span class="n">selected_features</span> <span class="o">=</span> <span class="n">select_top_features_by_importance</span><span class="p">(</span><span class="n">X_train_for_fs</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="n">TOP_K_FEATURES</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Selected features (RF importance): </span><span class="si">{</span><span class="n">selected_features</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown feature_selection_method: </span><span class="si">{</span><span class="n">feature_selection_method</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
        <span class="c1"># 8. Data Scaling</span>
        <span class="k">if</span> <span class="n">data_leak</span><span class="p">:</span>
            <span class="c1"># Fit scaler on combined train and validation data if data_leak is True</span>
            <span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
            <span class="n">scaler</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">X_train_for_fs</span><span class="p">[</span><span class="n">selected_features</span><span class="p">],</span> <span class="n">X_val_for_fs</span><span class="p">[</span><span class="n">selected_features</span><span class="p">]]))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Scaler was fit using both X_train and X_val (data_leak=True).&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Fit scaler only on training data</span>
            <span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
            <span class="n">scaler</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_for_fs</span><span class="p">[</span><span class="n">selected_features</span><span class="p">])</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Scaler was fit using only X_train (standard procedure).&quot;</span><span class="p">)</span>

        <span class="n">X_test_for_fs</span> <span class="o">=</span> <span class="n">X_test</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;subject_id&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
        <span class="n">X_test_for_fs</span> <span class="o">=</span> <span class="n">X_test_for_fs</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># 9. Get Classifier and Train</span>
        <span class="n">clf</span> <span class="o">=</span> <span class="n">get_classifier</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span>

        <span class="c1"># Construct suffix for model saving based on applied techniques</span>
        <span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">tag</span><span class="p">:</span>
            <span class="n">suffix</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">elif</span> <span class="n">target_subjects</span><span class="p">:</span>
            <span class="n">safe_targets</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">target_subjects</span><span class="p">))[:</span><span class="mi">40</span><span class="p">]</span>
            <span class="n">suffix</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;_targets-</span><span class="si">{</span><span class="n">safe_targets</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;PBS_ARRAY_INDEX&quot;</span><span class="p">):</span>
            <span class="n">suffix</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;_group</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;PBS_ARRAY_INDEX&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        
        <span class="k">if</span> <span class="n">use_coral</span><span class="p">:</span>
            <span class="n">suffix</span> <span class="o">+=</span> <span class="s2">&quot;_coral&quot;</span>
        <span class="k">if</span> <span class="n">use_domain_mixup</span><span class="p">:</span>
            <span class="n">suffix</span> <span class="o">+=</span> <span class="s2">&quot;_mixup&quot;</span>
        <span class="k">if</span> <span class="n">use_vae</span><span class="p">:</span>
            <span class="n">suffix</span> <span class="o">+=</span> <span class="s2">&quot;_vae&quot;</span>

        <span class="n">common_train</span><span class="p">(</span>
            <span class="n">X_train_for_fs</span><span class="p">,</span> <span class="n">X_val_for_fs</span><span class="p">,</span> <span class="n">X_test_for_fs</span><span class="p">,</span>
            <span class="n">y_train</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span>
            <span class="n">selected_features</span><span class="p">,</span>
            <span class="n">model_name</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">clf</span><span class="p">,</span>
            <span class="n">scaler</span><span class="o">=</span><span class="n">scaler</span><span class="p">,</span>
            <span class="n">suffix</span><span class="o">=</span><span class="n">suffix</span><span class="p">,</span>
            <span class="n">data_leak</span><span class="o">=</span><span class="n">data_leak</span><span class="p">,</span>
        <span class="p">)</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, ynakagama.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>